# Lyra - 技術スタック & インフラストラクチャ

**プロジェクト**: Lyra - 音楽ジャンル分類
**最終更新**: 2024-11-13
**ステータス**: 設計フェーズ

---

## 概要

Lyraは3つのフェーズで開発されます：
1. **Phase 1**: Python CLI（1-2ヶ月）
2. **Phase 2**: Webアプリケーション（1-2ヶ月）
3. **Phase 3**: iOSネイティブアプリ（2-3ヶ月）- **目標: App Store公開**

---

## Phase 1: CLI開発（1-2ヶ月目）

### 技術スタック

**言語:**
- Python 3.10

**パッケージマネージャー:**
- Poetry

**コアライブラリ:**
```toml
[tool.poetry.dependencies]
python = "^3.10"
librosa = "^0.10.0"           # 音響特徴抽出
sounddevice = "^0.4.6"        # マイク入力
scikit-learn = "^1.3.0"       # 機械学習（Random Forest）
numpy = "^1.24.0"             # 数値計算
scipy = "^1.10.0"             # 科学計算
soundfile = "^0.12.0"         # 音声ファイルI/O
joblib = "^1.3.0"             # モデルシリアライズ
tqdm = "^4.65.0"              # プログレスバー
colorama = "^0.4.6"           # ターミナルカラー
```

**開発ツール:**
```toml
[tool.poetry.dev-dependencies]
black = "^23.0.0"             # コードフォーマッター
ruff = "^0.1.0"               # リンター
pytest = "^7.4.0"             # テストフレームワーク
pytest-cov = "^4.1.0"         # コードカバレッジ
```

### 機能

- マイクから音声キャプチャ（5-10秒）
- 特徴抽出（MFCC、スペクトル特徴、テンポなど）
- ジャンル分類（10のメインジャンル）
- プログレス表示付きCLIインターフェース

### 費用

**$0**（ローカル開発のみ）

---

## Phase 2: Webアプリケーション（3-4ヶ月目）

### アーキテクチャ

```
┌─────────────────────────────────┐
│  ユーザー（ブラウザ）              │
└─────────────────────────────────┘
              ↓
┌─────────────────────────────────┐
│  フロントエンド（Vercel）          │
│  - Next.js 14 (App Router)      │
│  - TypeScript                   │
│  - Tailwind CSS                 │
└─────────────────────────────────┘
              ↓ REST API
┌─────────────────────────────────┐
│  バックエンド（Railway/GCP）       │
│  - FastAPI                      │
│  - Python 3.10                  │
│  - MLモデル（scikit-learn）      │
└─────────────────────────────────┘
```

### フロントエンド

**フレームワーク:** Next.js 14
**言語:** TypeScript
**スタイリング:** Tailwind CSS
**音声:** Web Audio API

**主要機能:**
- ワンボタン操作
- リアルタイム音声キャプチャ
- クリーンでミニマルなUI
- レスポンシブデザイン

**デプロイ:** Vercel
**費用:** $0（Hobbyプラン）

---

### バックエンド

**フレームワーク:** FastAPI
**言語:** Python 3.10
**ML:** scikit-learn（Random Forest）

**依存関係:**
```python
fastapi = "^0.104.0"
uvicorn = "^0.24.0"
pydantic = "^2.0.0"
python-multipart = "^0.0.6"
librosa = "^0.10.0"
scikit-learn = "^1.3.0"
numpy = "^1.24.0"
```

**APIエンドポイント:**
```
POST /api/analyze
- 入力: 音声ファイル（multipart/form-data）
- 出力: { "genre": "Acid Techno", "confidence": 0.92 }
```

**デプロイオプション:**

#### Option A: Railway（MVP推奨）
- **費用:** $0-15/月
- **セットアップ:** Git push自動デプロイ
- **機能:** PostgreSQL内蔵、ログ、メトリクス
- **容量:** 月1,000ユーザーまで

#### Option B: GCP Cloud Run（成長期向け）
- **費用:** $0-20/月（無料枠込み）
- **セットアップ:** Dockerコンテナ
- **機能:** オートスケール、従量課金
- **容量:** 月10,000ユーザーまで

---

### データベース

**Phase 2 MVP:**
- Railway PostgreSQL（バックエンドに含まれる）
- ユーザー分析データ保存（オプション）

**Phase 3 成長期:**
- GCP Cloud SQLへ移行オプション
- 費用: $10-30/月

---

### ストレージ

**GCS（Google Cloud Storage）**
- MLモデル（50-200MB）
- データセットバックアップ（オプション）
- 費用: $0-2/月（5GB無料枠）

---

### Phase 2 費用まとめ

| サービス | 月額費用 | 備考 |
|---------|---------|------|
| **Vercel**（フロントエンド） | $0 | 無料Hobbyプラン |
| **Railway**（バックエンド） | $0-15 | $5無料クレジット、その後従量 |
| **合計** | **$0-15** | **約¥0-2,250** |

**ユーザー数別の想定費用:**
- 0-100ユーザー: $0/月
- 100-500ユーザー: $3-8/月
- 500-1,000ユーザー: $8-15/月

---

## Phase 3: iOSアプリケーション（5-7ヶ月目）

**目標: Web版公開から2-3ヶ月後にApp Store公開**

### アーキテクチャ

```
┌─────────────────────────────────┐
│  iOSアプリ（Swift/SwiftUI）       │
│  - 音声キャプチャ（AVFoundation）  │
│  - UI（SwiftUI）                │
│  - ML推論                       │
└─────────────────────────────────┘
        ↓（Option AまたはB）

Option A: オンデバイスML
┌─────────────────────────────────┐
│  Core MLモデル                   │
│  （scikit-learnから変換）         │
└─────────────────────────────────┘

Option B: APIベース
┌─────────────────────────────────┐
│  バックエンドAPI（FastAPI on GCP）│
│  MLモデル（Python）              │
└─────────────────────────────────┘
```

### 技術スタック

**言語:** Swift 5.9+
**UIフレームワーク:** SwiftUI
**音声:** AVFoundation
**ML:** Core ML（オンデバイス）またはURLSession（API）

**主要機能:**
- ネイティブiOSインターフェース
- マイク権限ハンドリング
- リアルタイム音声キャプチャ
- スムーズなアニメーション
- オフライン機能（Core ML使用時）

### 開発アプローチ

#### 推奨: ハイブリッドアプローチ

**Phase 3A（5-6ヶ月目）: APIベースiOSアプリ**
```swift
iOSアプリ（Swift）
   ↓
PythonバックエンドAPI（FastAPI）
   ↓
MLモデル（scikit-learn）
```

**メリット:**
- 開発が速い（既存APIを使用）
- モデル更新が簡単（サーバー側）
- Web版と一貫性

**Phase 3B（7ヶ月目以降）: Core MLサポート追加**
```swift
iOSアプリ（Swift）
   ↓
Core MLモデル（Pythonから変換）
   ↓
オンデバイス推論（オフライン機能）
```

**メリット:**
- オフライン機能
- 低レイテンシ
- 推論コストなし
- プライバシー向上

---

### iOS費用構成

**開発:**
- Apple Developer Program: $99/年（約¥15,000/年）
- Xcode: 無料
- TestFlight: 無料

**バックエンド（APIアプローチの場合）:**
- Phase 2 Web版と同じ
- GCP Cloud Run: $0-20/月

**合計:** $99/年 + $0-20/月（バックエンド）

---

## 全フェーズの費用予測

### 1年目の内訳

| フェーズ | 期間 | 月額費用 | 合計費用 |
|---------|------|---------|---------|
| **Phase 1**（CLI） | 2ヶ月 | $0 | $0 |
| **Phase 2**（Web MVP） | 2ヶ月 | $0-5 | $0-10 |
| **Phase 2**（Web成長） | 6ヶ月 | $5-15 | $30-90 |
| **Phase 3**（iOS開発） | 2ヶ月 | $5-15 + $99 | $10-30 + $99 |
| **1年目合計** | 12ヶ月 | - | **$139-229** |

**日本円: ¥21,000-34,000/年（月額約¥1,750-2,850）**

---

### 月額予算: $20（約¥3,000）

**$20/月でカバーできる範囲:**

| ユーザー数 | インフラ費用 | カバー可能？ |
|-----------|------------|-----------|
| 0-1,000 | $0-10 | ✅ 可能 |
| 1,000-10,000 | $10-18 | ✅ 可能 |
| 10,000-30,000 | $18-56 | ⚠️ 収益化必要 |

**結論:** $20/月で最初の10,000ユーザーまで十分対応可能。

---

## デプロイ戦略

### Phase 2: Webアプリケーション

**フロントエンド（Vercel）:**
```bash
# 自動デプロイ
git push origin main
→ Vercel自動デプロイ
```

**バックエンド（Railway）:**
```bash
# 自動デプロイ
git push origin main
→ Railway自動デプロイ
```

**カスタムドメイン:**
- フロントエンド: lyra.yourdomain.com
- バックエンド: api.lyra.yourdomain.com

---

### Phase 3: iOSアプリケーション

**開発:**
```
1. Xcodeで開発
2. Simulatorでテスト
3. TestFlightベータテスト
4. App Store申請
```

**App Store申請チェックリスト:**
- [ ] アプリアイコン（1024x1024）
- [ ] スクリーンショット（全デバイスサイズ）
- [ ] アプリ説明（英語 + 日本語）
- [ ] プライバシーポリシー
- [ ] マイク使用説明
- [ ] 利用規約（必要に応じて）

**タイムライン:**
- 開発: 6-8週間
- TestFlightベータ: 1-2週間
- App審査: 1-2週間
- **合計: 2-3ヶ月**

---

## 技術移行パス

### MLモデルのアップグレード（将来）

**scikit-learnからPyTorchへ:**

アップグレードタイミング:
- より高精度が必要（80%+ → 90%+）
- より多くのサブジャンルをサポート
- 十分な学習データを収集

**移行:**
```python
# 現在: scikit-learn Random Forest
model = RandomForestClassifier()

# 将来: PyTorch CNN
model = torch.nn.Sequential(
    Conv2d(...),
    MaxPool2d(...),
    Dense(...),
)
```

**コスト影響:** 最小限（同じインフラで動作）

---

### スケーリング戦略

**スケールタイミング:**

| 指標 | トリガー | アクション |
|------|---------|----------|
| **ユーザー** | > 10,000/月 | GCP Cloud Runへ移行 |
| **リクエスト** | > 500,000/月 | ロードバランシング追加 |
| **モデルサイズ** | > 500MB | モデル配信にCDN使用 |
| **精度** | < 70% | データ追加、モデル改善 |

---

## 開発環境

### 必要なツール

**全フェーズ共通:**
- Git
- Python 3.10
- Poetry
- VS Code（推奨）

**Phase 2（Web）:**
- Node.js 18+
- npm/yarn
- Railway CLI（オプション）
- GCP CLI（Cloud Run用）

**Phase 3（iOS）:**
- macOS（必須）
- Xcode 15+
- Swift 5.9+
- iOSシミュレーター
- Apple Developer アカウント（$99/年）

---

## リスク管理

### 技術的リスク

**リスク1: ML精度が低い**
- 対策: 実績のあるGTZANデータセットから開始
- 代替: 研究の事前学習モデルを使用

**リスク2: サーバー費用が高い**
- 対策: Railwayから開始（安価）
- 代替: モデルサイズ最適化、キャッシング追加

**リスク3: iOSアプリがリジェクト**
- 対策: Appleガイドラインを厳守
- 代替: 詳細なプライバシーポリシー、明確なマイク使用説明

**リスク4: 開発遅延**
- 対策: フェーズ別アプローチ、MVP優先
- 代替: iOSスキップ、Web注力

---

## 成功指標

### Phase 1（CLI）
- ✅ 10ジャンル分類可能
- ✅ 精度 ≥ 70%
- ✅ 推論時間 < 3秒

### Phase 2（Web）
- ✅ 本番環境デプロイ
- ✅ 100+ユーザー
- ✅ ポジティブなフィードバック
- ✅ 月額費用 < $20

### Phase 3（iOS）
- ✅ App Store承認
- ✅ 初月1,000+ダウンロード
- ✅ 4+スター評価
- ✅ 好意的なレビュー

---

## タイムライン

### 詳細ロードマップ

**1-2ヶ月目: Phase 1（CLI）**
- 第1-2週: セットアップ、データセット取得
- 第3-4週: 特徴抽出実装
- 第5-6週: モデル学習と評価
- 第7-8週: CLIインターフェースとテスト

**3-4ヶ月目: Phase 2（Web）**
- 第9-10週: FastAPIバックエンド
- 第11-12週: Next.jsフロントエンド
- 第13-14週: 統合とテスト
- 第15-16週: デプロイと最適化

**5-7ヶ月目: Phase 3（iOS）**
- 第17-20週: Swift/SwiftUI開発
- 第21-22週: API統合
- 第23-24週: TestFlightベータ
- 第25-26週: App Store申請

**目標: 7ヶ月目にiOS App Store公開**

---

## 結論

### 確定した技術スタック

**バックエンド:** Python 3.10 + FastAPI
**フロントエンド:** Next.js 14 + TypeScript
**モバイル:** Swift + SwiftUI（iOSネイティブ）
**ML:** scikit-learn → PyTorch（将来）
**デプロイ:** Vercel（フロントエンド）+ Railway/GCP（バックエンド）
**予算:** $20/月（約¥3,000/月）

**タイムライン:** 7ヶ月でiOS App Store公開

**リスク:** 低 - フェーズ別アプローチ、実績のある技術

**ROI:** 高 - Python + iOSスキル、ポートフォリオ、収益可能性

---

*このドキュメントはプロジェクト進行に伴い更新されます。*
